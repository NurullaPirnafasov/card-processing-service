<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.22.xsd">

    <changeSet id="1" author="nurulla">
        <sql>
            CREATE TABLE auth_user
            (
                id       BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                password VARCHAR(255),
                username VARCHAR(255)
            );
        </sql>
    </changeSet>

    <changeSet id="2" author="nurulla">
        <sql>
            CREATE TABLE card
            (
                id       VARCHAR(255) PRIMARY KEY NOT NULL,
                balance  NUMERIC(38, 2)           NOT NULL,
                currency VARCHAR(255)             NOT NULL,
                status   VARCHAR(255)             NOT NULL,
                user_id  BIGINT                   NOT NULL,
                CONSTRAINT fk_card_user FOREIGN KEY (user_id) REFERENCES auth_user (id)
            );
        </sql>
    </changeSet>

    <changeSet id="3" author="nurulla">
        <sql>
            ALTER TABLE card
                ADD CONSTRAINT card_currency_check CHECK (currency IN ('UZS', 'USD'));
        </sql>
    </changeSet>

    <changeSet id="4" author="nurulla">
        <sql>
            ALTER TABLE card
                ADD CONSTRAINT card_status_check CHECK (status IN ('ACTIVE', 'BLOCKED', 'CLOSED'));
        </sql>
    </changeSet>

    <changeSet id="5" author="nurulla">
        <sql>
            CREATE TABLE idempotency_keys
            (
                key           VARCHAR(255) PRIMARY KEY    NOT NULL,
                created_at    TIMESTAMP(6) WITH TIME ZONE NOT NULL,
                resource      VARCHAR(255)                NOT NULL,
                response_data TEXT                        NOT NULL
            );
        </sql>
    </changeSet>

    <changeSet id="6" author="nurulla">
        <sql>
            CREATE TABLE transaction
            (
                id            VARCHAR(255) PRIMARY KEY NOT NULL,
                after_balance NUMERIC(38, 2)           NOT NULL,
                amount        NUMERIC(38, 2)           NOT NULL,
                currency      VARCHAR(255)             NOT NULL,
                exchange_rate BIGINT,
                external_id   VARCHAR(255)             NOT NULL UNIQUE,
                purpose       VARCHAR(255),
                type          VARCHAR(255)             NOT NULL,
                card_id       VARCHAR(255)             NOT NULL,
                CONSTRAINT fk_transaction_card FOREIGN KEY (card_id) REFERENCES card (id)
            );
        </sql>
    </changeSet>

    <changeSet id="7" author="nurulla">
        <sql>
            ALTER TABLE transaction
                ADD CONSTRAINT transaction_currency_check CHECK (currency IN ('UZS', 'USD'));
        </sql>
    </changeSet>

    <changeSet id="8" author="nurulla">
        <sql>
            ALTER TABLE transaction
                ADD CONSTRAINT transaction_type_check CHECK (type IN ('DEBIT', 'CREDIT'));
        </sql>
    </changeSet>

    <changeSet id="9" author="nurulla">
        <sql>
            ALTER TABLE transaction
                ADD CONSTRAINT transaction_purpose_check CHECK (purpose IN ('P2P', 'PAYMENT'));
        </sql>
    </changeSet>

    <changeSet id="10" author="nurulla">
        <sql>
            INSERT INTO auth_user (username, password) VALUES
                                                           ('ali', 'password123'),
                                                           ('vali', 'password456');
        </sql>
    </changeSet>

    <changeSet id="11" author="nurulla">
        <sql>
            INSERT INTO card (id, balance, currency, status, user_id) VALUES
                                                                          ('UZCARD-001', 100000, 'UZS', 'ACTIVE', 1),
                                                                          ('VISA-001', 500, 'USD', 'ACTIVE', 2);
        </sql>
    </changeSet>

    <changeSet id="12" author="nurulla">
        <sql>
            INSERT INTO idempotency_keys (key, created_at, resource, response_data) VALUES
                                                                                        ('key-1', NOW(), 'create_card', '{}'),
                                                                                        ('key-2', NOW(), 'transfer_money', '{}');
        </sql>
    </changeSet>

    <changeSet id="13" author="nurulla">
        <sql>
            INSERT INTO transaction (id, after_balance, amount, currency, exchange_rate, external_id, purpose, type, card_id) VALUES
                                                                                                                                  ('tx-001', 100000, 100000, 'UZS', 1, 'ext-001', 'P2P', 'DEBIT', 'UZCARD-001'),
                                                                                                                                  ('tx-002', 500, 500, 'USD', 1, 'ext-002', 'PAYMENT', 'CREDIT', 'VISA-001');
        </sql>
    </changeSet>

    <changeSet id="14" author="nurulla">
        <sql>
            ALTER TABLE transaction DROP CONSTRAINT transaction_purpose_check;
            ALTER TABLE transaction
                ADD CONSTRAINT transaction_purpose_check
                    CHECK (purpose IN ('P2P', 'PAYMENT', 'TOP_UP'));
        </sql>
    </changeSet>


</databaseChangeLog>
